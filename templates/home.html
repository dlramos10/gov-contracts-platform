@app.route('/home')
def home():
    if 'user' not in session:
        return redirect(url_for('login'))

    keyword = request.args.get('keyword', '')
    start_date = request.args.get('start_date', '')
    end_date = request.args.get('end_date', '')
    naics = request.args.get('naics', '')

    # Set default date range to last 7 days if nothing entered
    today = datetime.date.today()
    if not end_date:
        end_date = today.strftime("%m/%d/%Y")
    else:
        end_date = datetime.datetime.strptime(end_date, "%Y-%m-%d").strftime("%m/%d/%Y")

    if not start_date:
        start_date = (today - datetime.timedelta(days=7)).strftime("%m/%d/%Y")
    else:
        start_date = datetime.datetime.strptime(start_date, "%Y-%m-%d").strftime("%m/%d/%Y")

    headers = {"X-API-Key": SAM_API_KEY}
    params = {
        "postedFrom": start_date,
        "postedTo": end_date,
        "ptype": "o",
        "limit": 50
    }

    if keyword:
        params["q"] = keyword
    if naics:
        params["naics"] = naics

    response = requests.get(SAM_URL, headers=headers, params=params)
    results = []

    if response.status_code == 200:
        data = response.json()
        for item in data.get("opportunitiesData", []):
            sol_num = item.get("solicitationNumber", "N/A")
            title = item.get("title", "N/A")
            agency = item.get("departmentName", "N/A")
            raw_date = item.get("postedDate", "")
            try:
                date_obj = datetime.datetime.strptime(raw_date[:10], "%m/%d/%Y")
                date = date_obj.strftime("%Y-%m-%d")
            except Exception:
                date = "Unknown"
            naics_code = item.get("naics", {}).get("code", "N/A")
            results.append((sol_num, title, agency, date, naics_code))
    else:
        print(f"API Error: {response.status_code} - {response.text}")

    return render_template('home.html', user=session['user'], opportunities=results)
